@page "/"

<PageTitle>Index</PageTitle>

<ToolBar UploadImage="@UploadImage" 
    CreatePalette="@CreatePalette" />

@* @if (ImgSrc != null)
{
    <img src="@ImgSrc" />
} *@

<div class="container-fluid vh-100">
    <div class="row">
        @for (int i = 0; i < Colors.Count; i++)
        {
            int j = i;
            <ColorPane Id=@j Color=@Colors[j] RGBColor=@HexToRGB(Colors[j])
                UpdateColorPane="@UpdateColorPane"
                RemoveColorPane="@RemoveColorPane" />
        }
    </div>
</div>


@code {
    private List<string> Colors = Enumerable
        .Repeat("#FFFFFF", 5)
        .ToList();

    private string? ImgSrc;
    
    private string Format = "RGB";

    private int NumClusters = 8;

    private byte[]? byteData;

    private RGB HexToRGB(string color)
    {
        byte r = Convert.ToByte(color.Substring(1, 2), 16);
        byte g = Convert.ToByte(color.Substring(3, 2), 16);
        byte b = Convert.ToByte(color.Substring(5, 2), 16);

        return new RGB(r, g, b);
    }

    private async void UploadImage(InputFileChangeEventArgs e)
    {
        int bmpHeaderSize = 54;
        int maxWidth = 640;
        int maxFileSize = 3200000;
        
        var bmpFile = await e.File
            .RequestImageFileAsync("image/bmp", maxWidth, maxWidth);

        using var input = bmpFile.OpenReadStream(maxFileSize);
        using var ms = new MemoryStream();
        await input.CopyToAsync(ms);

        byteData = ms.ToArray()
            .Skip(bmpHeaderSize)
            .ToArray();

        ImgSrc = ($"data:{e.File.ContentType};base64," + 
            $"{Convert.ToBase64String(ms.ToArray())}");
    }

    private void CreatePalette()
    {
        if (byteData == null)
            return;

        RGB[] RGBData = new RGB[byteData.Length / 3];

        for (int i = 2; i < byteData.Length; i += 3)
            RGBData[(i - 2) / 3] = new RGB(byteData[i],
                byteData[i - 1], byteData[i - 2]);

        Colors = KMeans.Cluster<RGB>(RGBData)
            .ToList();
    }

    public void UpdateColorPane(int id, string color)
    {
        Colors[id] = color;
    }

    public void RemoveColorPane(int id)
    {
        Colors?.RemoveAt(id);
        StateHasChanged();
    }
}